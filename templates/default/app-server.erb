upstream app {
  server <%= node['app_server']['sock'] %> fail_timeout=0;
}

server {
  listen <%= node['app_server']['port'] || (node['app_server']['use_ssl'] ? 443 : 80) %>;
  server_name <%= node['app_server']['server_name'] %>;

  root <%= node['app_server']['root'] %>;

  access_log <%= node['app_server']['log_path'] %>/access.log main;
  error_log <%= node['app_server']['log_path'] %>/error.log;

  client_max_body_size <%= node['app_server']['client_max_body_size'] || '1m' %>;
  gzip_types text/plain text/css text/xml application/x-javascript;

  <% if node['app_server']['use_ssl'] -%>
  ssl                  on;
  ssl_certificate      app_server.pem;
  ssl_certificate_key  app_server.key;

  ssl_session_timeout  5m;

  ssl_protocols  SSLv2 SSLv3 TLSv1;
  ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
  ssl_prefer_server_ciphers   on;

  proxy_set_header    HTTPS   on;
  proxy_set_header    X-Forwarded-Proto https;
  <% end -%>

  location ~ ^/assets/ {
    expires 1y;
    add_header Cache-Control public;
    add_header ETag "";
    break;
  }

  location / {
    if (!-f $document_root$uri) {
      proxy_pass http://app;
    }
  }
}

<% if node['app_server']['use_ssl'] -%>
server {
  listen 80;
  server_name <%= node['app_server']['server_name'] %>;
  rewrite ^(.*)$ https://<%= node['app_server']['server_name'] %>$1 last;
}
<% end -%>
